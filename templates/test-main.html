<!DOCTYPE html>
<html>
<head>
    <title>Test Main Page</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #e0e0e0; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .analytics-section { 
            background: #1a1a1a; 
            border: 1px solid #444; 
            padding: 20px; 
            border-radius: 5px; 
            margin: 20px 0; 
        }
        .analytics-section h2 { 
            color: #fff; 
            border-bottom: 1px solid #444; 
            padding-bottom: 10px; 
            margin-top: 0; 
        }
        .charts-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin: 20px 0; 
        }
        .chart-container { 
            background: #2a2a2a; 
            border: 1px solid #555; 
            border-radius: 5px; 
            padding: 15px; 
            min-height: 300px; 
        }
        .chart-container h3 { 
            color: #fff; 
            margin-top: 0; 
            margin-bottom: 15px; 
            font-size: 1.1em; 
            text-align: center; 
        }
        .pie-chart-container { 
            grid-column: 1 / -1; 
            min-height: 400px; 
        }
        .loading { 
            color: #888; 
            text-align: center; 
            padding: 20px; 
            min-height: 200px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Main Page - Chart Positioning</h1>
        
        <div class="analytics-section">
            <h2>Visual Analytics</h2>
            
            <div class="chart-container pie-chart-container">
                <h3>Portfolio Composition</h3>
                <div id="pie-chart" class="loading">Loading portfolio composition...</div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Price Trend</h3>
                    <div id="price-chart" class="loading">Loading price data...</div>
                </div>
                
                <div class="chart-container">
                    <h3>Market Cap Trend</h3>
                    <div id="market-cap-chart" class="loading">Loading market cap data...</div>
                </div>
                
                <div class="chart-container">
                    <h3>24h Volume Trend</h3>
                    <div id="volume-chart" class="loading">Loading volume data...</div>
                </div>
                
                <div class="chart-container">
                    <h3>Circulating Supply Trend</h3>
                    <div id="supply-chart" class="loading">Loading supply data...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script>
        setTimeout(function() {
            console.log('Starting test main page...');
            
            if (typeof Plotly !== 'undefined') {
                loadPortfolioComposition();
                loadTimeSeriesCharts();
            } else {
                console.error('Plotly not available');
                document.getElementById('pie-chart').innerHTML = 'Plotly library not loaded';
            }
        }, 1000);
        
        async function loadPortfolioComposition() {
            try {
                const pieChartElement = document.getElementById('pie-chart');
                if (!pieChartElement) {
                    return;
                }
                
                const response = await fetch('/api/portfolio-composition');
                const data = await response.json();
                
                if (data.composition && data.composition.length > 0) {
                    // Clear loading text BEFORE rendering
                    pieChartElement.innerHTML = '';
                    
                    const labels = data.composition.map(item => item.symbol);
                    const values = data.composition.map(item => item.value);
                    const text = data.composition.map(item => 
                        `${item.symbol}<br>${item.percentage.toFixed(1)}%<br>$${item.value.toLocaleString()}`
                    );
                    
                    const plotData = [{
                        labels: labels,
                        values: values,
                        text: text,
                        textinfo: 'text',
                        hovertemplate: '<b>%{label}</b><br>Value: $%{value:,.0f}<br>Percentage: %{percent}<extra></extra>',
                        type: 'pie',
                        marker: {
                            colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'],
                            line: { color: '#fff', width: 2 }
                        }
                    }];
                    
                    const layout = {
                        title: {
                            text: 'Portfolio Composition by Asset',
                            font: { color: '#fff', size: 18 }
                        },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#e0e0e0', size: 12 },
                        showlegend: true,
                        legend: {
                            font: { color: '#e0e0e0', size: 12 },
                            orientation: 'h',
                            x: 0.5,
                            y: -0.1,
                            xanchor: 'center'
                        },
                        margin: { l: 50, r: 50, t: 50, b: 80 },
                        height: 350
                    };
                    
                    console.log('Calling Plotly.newPlot for pie chart...');
                    Plotly.newPlot('pie-chart', plotData, layout, {responsive: true, displayModeBar: false});
                    console.log('Pie chart rendered successfully');
                } else {
                    document.getElementById('pie-chart').innerHTML = 'No portfolio data available';
                }
            } catch (error) {
                console.error('Error loading portfolio composition:', error);
                document.getElementById('pie-chart').innerHTML = 'Error loading portfolio data';
            }
        }
        
        async function loadTimeSeriesCharts() {
            try {
                const chartElements = ['price-chart', 'market-cap-chart', 'volume-chart', 'supply-chart'];
                for (const id of chartElements) {
                    if (!document.getElementById(id)) {
                        return;
                    }
                }
                
                const response = await fetch('/api/time-series');
                const data = await response.json();
                
                if (data.timestamps && data.timestamps.length > 0) {
                    // Clear loading text BEFORE rendering all charts
                    document.getElementById('price-chart').innerHTML = '';
                    document.getElementById('market-cap-chart').innerHTML = '';
                    document.getElementById('volume-chart').innerHTML = '';
                    document.getElementById('supply-chart').innerHTML = '';
                    
                    // Price Chart
                    console.log('Rendering price chart...');
                    Plotly.newPlot('price-chart', [{
                        x: data.timestamps,
                        y: data.price,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#4ECDC4', width: 2 },
                        marker: { size: 4, color: '#4ECDC4' }
                    }], {
                        title: { text: 'Price (USD)', font: { color: '#fff', size: 16 } },
                        xaxis: { 
                            color: '#e0e0e0', 
                            gridcolor: '#444',
                            showgrid: true,
                            zeroline: false,
                            tickformat: '%m/%d %H:%M'
                        },
                        yaxis: { 
                            color: '#e0e0e0', 
                            gridcolor: '#444',
                            showgrid: true,
                            zeroline: false,
                            tickformat: '$.4f'
                        },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#e0e0e0', size: 12 },
                        margin: { l: 50, r: 50, t: 50, b: 50 },
                        showlegend: false
                    }, {responsive: true, displayModeBar: false});
                    
                    // Market Cap Chart
                    Plotly.newPlot('market-cap-chart', [{
                        x: data.timestamps,
                        y: data.market_cap,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#45B7D1', width: 2 },
                        marker: { size: 4, color: '#45B7D1' }
                    }], {
                        title: { text: 'Market Cap (USD)', font: { color: '#fff', size: 16 } },
                        xaxis: { 
                            color: '#e0e0e0', 
                            gridcolor: '#444',
                            showgrid: true,
                            zeroline: false,
                            tickformat: '%m/%d %H:%M'
                        },
                        yaxis: { 
                            color: '#e0e0e0', 
                            gridcolor: '#444',
                            showgrid: true,
                            zeroline: false,
                            tickformat: '$,.0f'
                        },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#e0e0e0', size: 12 },
                        margin: { l: 50, r: 50, t: 50, b: 50 },
                        showlegend: false
                    }, {responsive: true, displayModeBar: false});
                    
                    // Volume Chart
                    Plotly.newPlot('volume-chart', [{
                        x: data.timestamps,
                        y: data.volume_24h,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#FF6B6B', width: 2 },
                        marker: { size: 4, color: '#FF6B6B' }
                    }], {
                        title: { text: '24h Volume (USD)', font: { color: '#fff', size: 16 } },
                        xaxis: { 
                            color: '#e0e0e0', 
                            gridcolor: '#444',
                            showgrid: true,
                            zeroline: false,
                            tickformat: '%m/%d %H:%M'
                        },
                        yaxis: { 
                            color: '#e0e0e0', 
                            gridcolor: '#444',
                            showgrid: true,
                            zeroline: false,
                            tickformat: '$,.0f'
                        },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#e0e0e0', size: 12 },
                        margin: { l: 50, r: 50, t: 50, b: 50 },
                        showlegend: false
                    }, {responsive: true, displayModeBar: false});
                    
                    // Supply Chart
                    Plotly.newPlot('supply-chart', [{
                        x: data.timestamps,
                        y: data.circulating_supply,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#96CEB4', width: 2 },
                        marker: { size: 4, color: '#96CEB4' }
                    }], {
                        title: { text: 'Circulating Supply', font: { color: '#fff', size: 16 } },
                        xaxis: { 
                            color: '#e0e0e0', 
                            gridcolor: '#444',
                            showgrid: true,
                            zeroline: false,
                            tickformat: '%m/%d %H:%M'
                        },
                        yaxis: { 
                            color: '#e0e0e0', 
                            gridcolor: '#444',
                            showgrid: true,
                            zeroline: false,
                            tickformat: ',.0f'
                        },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#e0e0e0', size: 12 },
                        margin: { l: 50, r: 50, t: 50, b: 50 },
                        showlegend: false
                    }, {responsive: true, displayModeBar: false});
                } else {
                    // Show no data message for all charts
                    ['price-chart', 'market-cap-chart', 'volume-chart', 'supply-chart'].forEach(id => {
                        document.getElementById(id).innerHTML = 'No time series data available';
                    });
                }
            } catch (error) {
                console.error('Error loading time series data:', error);
                ['price-chart', 'market-cap-chart', 'volume-chart', 'supply-chart'].forEach(id => {
                    document.getElementById(id).innerHTML = 'Error loading chart data';
                });
            }
        }
    </script>
</body>
</html>
